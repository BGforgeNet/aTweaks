

// Imp

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DIMP01~                                                             // Imp
             ~GORBAT4~                                                             // Imp
               ~IMP01~                                                             // Imp
             ~TELIMP1~                                                             // Imp
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DIMP~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                  // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~RINGDEMN~                                                         // removes RINGDEMN.ITM (Imps are not actual Fiends in 2E)
REMOVE_CRE_ITEM ~REGHP1~                                                           // removes REGHP1.ITM (regeneration now handled via equipped weapon)
WRITE_LONG 0x14 1400                                                               //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "18"                                                                  // new hit point value
      "newac"    = "2"                                                                   // new Armor Class value
      "newth"    = "19"                                                                  // new THAC0 value
      "newapr"   = "1"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "25"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "100"                                                                 // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "2"                                                                   // new level (first class)
      "newstr"   = "10"                                                                  // new Strength value
      "newint"   = "10"                                                                  // new Intelligence value
      "newwis"   = "12"                                                                  // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "10"                                                                  // new Constitution value
      "newchr"   = "14"                                                                  // new Charisma value
      "newmor"   = "10"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "60"                                                                  // new morale recovery value
      "newrace"  = "141"                                                                 // new race (Imp)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DIMP01"                                                              // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "GORBAT4"                                                             // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "IMP01"                                                               // enforced creature 4 (uses strict PnP values)
      "enfc04"   = "TELIMP1"                                                             // enforced creature 5 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HIMP"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "DEMIMP"                                                            // fourth AI script name
"script05"   = "BPWDASGT"                                                          // Big Picture script
"script06"   = "DW#MELEE"                                                          // SCSII melee script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "98" END                                                // mark opcode #98 (Regeneration) for deletion
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Hellcat

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~GORCAMB6~                                                           // Hellcat
              ~GORCAMB7~                                                           // Hellcat
               ~HGFEL01~                                                           // Hellcat
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
SAY NAME1 @732 SAY NAME2 @732                                                      // Hellcat
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DFCAT~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 3000
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "51"                                                                  // new hit point value
      "newac"    = "6"                                                                   // new Armor Class value
      "newth"    = "13"                                                                  // new THAC0 value
      "newapr"   = "3"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "20"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "0"                                                                   // new Resist Electricity value
      "newlvl1"  = "7"                                                                   // new level (first class)
      "newstr"   = "17"                                                                  // new Strength value
      "newint"   = "10"                                                                  // new Intelligence value
      "newwis"   = "10"                                                                  // new Wisdom value
      "newdex"   = "18"                                                                  // new Dexterity value
      "newcon"   = "14"                                                                  // new Constitution value
      "newchr"   = "16"                                                                  // new Charisma value
      "newmor"   = "14"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "GORCAMB6"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "GORCAMB7"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "HGFEL01"                                                             // enforced creature 3 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HFCAT"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script05"   = "BPDEMON"                                                           // Big Picture Demon AI
"script06"   = "DW#MELEE"                                                          // SCSII melee script
"skipfile01" = "GORCAMB6"                                                          // skip script patching for a designated file
"skipfile02" = "GORCAMB7"                                                          // skip script patching for a designated file
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "120" END                                               // mark opcode #120 (Protection from Melee Weapons) for deletion
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block

// Special case, inlined script addition for Aesgareth's Hellcats (Watcher's Keep Cambion)

<<<<<<<<aTweaks/inlined/rr#fcatx.baf
IF
        Allegiance(Myself,EVILCUTOFF)
	!GlobalTimerNotExpired("RR#Cast","LOCALS")
	!StateCheck(Myself,STATE_INVISIBLE)
	!Global("dvgldust","LOCALS",1)
	!CheckStatGT(Player1,0,TRUE_SIGHT)
	!CheckStatGT(Player2,0,TRUE_SIGHT)
	!CheckStatGT(Player3,0,TRUE_SIGHT)
	!CheckStatGT(Player4,0,TRUE_SIGHT)
	!CheckStatGT(Player5,0,TRUE_SIGHT)
	!CheckStatGT(Player6,0,TRUE_SIGHT)
	!CheckStatGT([GOODCUTOFF.0.PLANATAR],0,TRUE_SIGHT)
	!CheckStatGT([GOODCUTOFF.0.DARKPLANATAR],0,TRUE_SIGHT)
THEN
	RESPONSE #100
		SetGlobalTimer("RR#Cast","LOCALS",6)
                ApplySpellRES("RR#WI405",Myself) // Improved Invisibility
END
>>>>>>>>

EXTEND_TOP ~GORCAMB6.BCS~  ~aTweaks/inlined/rr#fcatx.baf~


// Erinyes

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DERINY01~                                                           // Erinyes
               ~GORBAT2~                                                           // Erinyes
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
WRITE_LONG 0x14 7000                                                               //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "48"                                                                  // new hit point value
      "newac"    = "2"                                                                   // new Armor Class value
      "newth"    = "13"                                                                  // new THAC0 value
      "newapr"   = "1"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "0"                                                                   // new Resist Electricity value
      "newlvl1"  = "6"                                                                   // new level (first class)
      "newstr"   = "17"                                                                  // new Strength value
      "newint"   = "14"                                                                  // new Intelligence value
      "newwis"   = "16"                                                                  // new Wisdom value
      "newdex"   = "18"                                                                  // new Dexterity value
      "newcon"   = "14"                                                                  // new Constitution value
      "newchr"   = "18"                                                                  // new Charisma value
      "newmor"   = "12"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DERINY01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "GORBAT2"                                                             // enforced creature 2 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HERIN"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "ERINYES"                                                           // fourth AI script name
"script05"   = "BPDEMON"                                                           // Big Picture Demon AI
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "98" END                                                // mark opcode #98 (Regeneration) for deletion
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Bone Fiend

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DBONEF01~                                                           // Bone Fiend
               ~GORBAT5~                                                           // Bone Fiend
              ~MELSUM02~                                                           // Bone Fiend
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DBFND~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
REPLACE_CRE_ITEM ~RINGDEMN~ #0 #0 #0 ~UNDROPPABLE~ ~RRING~                         // replace undead immunities with fiend immunities 
REMOVE_CRE_ITEM ~IMMUNE2~                                                          // removes IMMUNE2.ITM (no immunity to +1 weapons in PnP)
REMOVE_CRE_ITEM ~REGHP2R~                                                          // removes REGHP2R.ITM (no regeneration in PnP)
WRITE_LONG 0x14 7000                                                               //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "40"                                                                  // new hit point value
      "newac"    = "3"                                                                   // new Armor Class value
      "newth"    = "15"                                                                  // new THAC0 value
      "newapr"   = "4"                                                                   // new number of attacks per round
      "newsvd"   = "11"                                                                  // new Save vs. Death
      "newsvw"   = "13"                                                                  // new Save vs. Wand
      "newsvp"   = "12"                                                                  // new Save vs. Polymorph
      "newsvb"   = "13"                                                                  // new Save vs. Breath
      "newsvs"   = "14"                                                                  // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "0"                                                                   // new Resist Electricity value
      "newlvl1"  = "5"                                                                   // new level (first class)
      "newstr"   = "16"                                                                  // new Strength value
      "newstrx"  = "0"                                                                   // new Exceptional Strength value
      "newint"   = "12"                                                                  // new Intelligence value
      "newwis"   = "12"                                                                  // new Wisdom value
      "newdex"   = "14"                                                                  // new Dexterity value
      "newcon"   = "15"                                                                  // new Constitution value
      "newchr"   = "10"                                                                  // new Charisma value
      "newmor"   = "12"                                                                  // new morale value
      "newmorb"  = "4"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DBONEF01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "GORBAT5"                                                             // enforced creature 2 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HBFND"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "BPDEMON"                                                           // Big Picture Demon AI
"script05"   = "DEMBAL01"                                                          // Big Picture script (misassigned?)
"script06"   = "DW#MELEE"                                                          // SCSII melee script
"script07"   = "DW#BONEF"                                                          // SCSII Bone Fiend script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Abishai (Red)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~ABISRED1~                                                           // Abishai
              ~DEMABI01~                                                           // Abishai
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REMOVE_CRE_ITEM ~HELMNOAN~                                                         // removes HELMNOAN.ITM (no critical hit immunity in PnP)
REPLACE_CRE_ITEM ~RR#DABIS~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 9000                                                               //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "51"                                                                  // new hit point value
      "newac"    = "1"                                                                   // new Armor Class value
      "newth"    = "13"                                                                  // new THAC0 value
      "newapr"   = "3"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "0"                                                                   // new Resist Electricity value
      "newlvl1"  = "6"                                                                   // new level (first class)
      "newstr"   = "15"                                                                  // new Strength value
      "newint"   = "10"                                                                  // new Intelligence value
      "newwis"   = "12"                                                                  // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "15"                                                                  // new Constitution value
      "newchr"   = "16"                                                                  // new Charisma value
      "newmor"   = "12"                                                                  // new morale value
      "newmorb"  = "6"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMABI01"                                                            // enforced creature 1 (uses strict PnP values)
       enfc02    = abisred1
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HABIS"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "BPDEMON"                                                           // Big Picture Demon AI
"script05"   = "DW#MELEE"                                                          // SCSII melee script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Cornugon

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DEMCOR01~                                                           // Cornugon
              ~DEADDEM1~                                                           // Cornugon
               ~GORBAT3~                                                           // Cornugon
               ~TELCOR1~                                                           // Cornugon
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DCORN~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 10000
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "80"                                                                  // new hit point value
      "newac"    = "-2"                                                                  // new Armor Class value
      "newth"    = "11"                                                                  // new THAC0 value
      "newapr"   = "2"                                                                   // new number of attacks per round
      "newsvd"   = "8"                                                                   // new Save vs. Death
      "newsvw"   = "10"                                                                  // new Save vs. Wand
      "newsvp"   = "9"                                                                   // new Save vs. Polymorph
      "newsvb"   = "9"                                                                   // new Save vs. Breath
      "newsvs"   = "11"                                                                  // new Save vs. Spell
      "newmr"    = "50"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "0"                                                                   // new Resist Electricity value
      "newlvl1"  = "10"                                                                  // new level (first class)
      "newstr"   = "18"                                                                  // new Strength value
      "newstrx"  = "100"                                                                 // new Exceptional Strength value
      "newint"   = "16"                                                                  // new Intelligence value
      "newwis"   = "14"                                                                  // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "17"                                                                  // new Constitution value
      "newchr"   = "16"                                                                  // new Charisma value
      "newmor"   = "14"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMCOR01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "DEADDEM1"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "GORBAT3"                                                             // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "TELCOR1"                                                             // enforced creature 4 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HCORN"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "CORNUGON"                                                          // fourth AI script name
"script05"   = "BPDEMON"                                                           // Big Picture Demon AI
"script06"   = "DW#MELEE"                                                          // SCSII melee script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
    opcode = "206"                                                                     // effect: #206 (Protection from Spell)
    target = "1"                                                                       // target: 1 (self)
    timing = "9"                                                                       // timing mode: 9 (permanent after death)
    "duration" = "0"                                                                   // duration: 0
    "sectype" = "0"                                                                    // secondary type: none
    probability1 = "100"                                                               // probability1: 100%
  STR_VAR
    "resource"  = "RR#WI308"                                                           // resref: RR#WI308.SPL (Cornugon's own Lightning Bolt)
    "effsource" = ""                                                                   // effsource: none
END
WRITE_BYTE  0x2E "49"                                                              // major color (brown)
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Pit Fiend

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
                ~DEMPIT~                                                           // Pit Fiend
              ~DEMPIT01~                                                           // Pit Fiend
               ~TELPIT1~                                                           // Pit Fiend
               ~TELPIT2~                                                           // Pit Fiend
               ~GORBAT1~                                                           // Ka'rashur (Watcher's Keep Baatezu leader)
               dempitsu                                                            //Summoned Pit Fiend  
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DPITF~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace generic attack with a Pit Fiend specific attack
WRITE_LONG 0x14 21000
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "104"                                                                 // new hit point value
      "newac"    = "-5"                                                                  // new Armor Class value
      "newth"    = "13"                                                                  // new THAC0 value
      "newapr"   = "5"                                                                   // new number of attacks per round
      "newsvd"   = "5"                                                                   // new Save vs. Death
      "newsvw"   = "7"                                                                   // new Save vs. Wand
      "newsvp"   = "6"                                                                   // new Save vs. Polymorph
      "newsvb"   = "5"                                                                   // new Save vs. Breath
      "newsvs"   = "8"                                                                   // new Save vs. Spell
      "newmr"    = "50"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "0"                                                                   // new Resist Electricity value
      "newlvl1"  = "13"                                                                  // new level (first class)
      "newstr"   = "18"                                                                  // new Strength value
      "newstrx"  = "100"                                                                 // new Exceptional Strength value
      "newint"   = "18"                                                                  // new Intelligence value
      "newwis"   = "16"                                                                  // new Wisdom value
      "newdex"   = "16"                                                                  // new Dexterity value
      "newcon"   = "16"                                                                  // new Constitution value
      "newchr"   = "25"                                                                  // new Charisma value
      "newmor"   = "20"                                                                  // new morale value
      "newmorb"  = "0"                                                                   // new morale break value
      "newmorr"  = "1"                                                                   // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "179"                                                                 // new class (Imp)
      "newalign" = "19"                                                                  // new alignment (Lawful Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMPIT"                                                              // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "DEMPIT01"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "TELPIT1"                                                             // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "TELPIT2"                                                             // enforced creature 4 (uses strict PnP values)
       enfc05    = dempitsu   
  END                                                                                // ends FUNCTION call
END
PATCH_IF "%file%" STRING_COMPARE_CASE dempitsu BEGIN
  LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
    STR_VAR                                                                            // Initialize strings
      "newscript"  = "rr#hpitf"                                                          // new AI script
      "script01"   = ""                                                                  // first AI script name
      "script02"   = "None"                                                              // second AI script name
      "script03"   = "WTASIGHT"                                                          // third AI script name
      "script04"   = "DEMPIT"                                                            // fourth AI script name
      "script05"   = "DEMPIT01"                                                          // fifth AI script name
      "script06"   = "TELPIT1"                                                           // sixth AI script name
      "script07"   = "DEMPTJ"                                                            // sixth AI script name
      "script08"   = "BPDEMON"                                                           // Big Picture Demon AI
      "script09"   = "BPDEMPIT"                                                          // Big Picture Pit Fiend AI
      "script10"   = "DW#MELEE"                                                          // SCSII melee script
      "skipfile01" = "GORBAT1"                                                           // skip script patching for a designated file
  END                                                                                // ends FUNCTION call
END
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR                                                                            // initialize strings
  "effsource" = ""                                                                   // effsource: none
  END                                                                                // ends FUNCTION                                                                            // ends FUNCTION
END
WRITE_SHORT 0x28 "4352"                                                            // special case, Pit Fiends should use the TANARRI (winged demon) avatar
PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells (prevents AI quirks)
            ~SPIN561~                                                              // Fire Giant Lava Pit (FIRE_GIANT_LAVA)
            ~SPIN819~                                                              // Lava Burst (LAVA_BURST)
            ~SPWI022~                                                              // Lava Pit (TRAP_MUCK)
            ~SPWI103~                                                              // Burning Hands
            ~SPWI217~                                                              // Agannazar's Scorcher
            ~SPWI304~                                                              // Fireball
           ~RR#WI304~                                                              // Pit Fiend's own Fireball
            ~SPWI502~                                                              // Cloudkill
            ~SPWI523~                                                              // Sunfire
            ~SPWI712~                                                              // Delayed Blast Fireball
            ~SPWI810~                                                              // Incendiary Cloud
            ~SPWI911~                                                              // Meteor Swarm
            ~SPPR705~                                                              // Fire Storm
BEGIN                                                                              // execute the following
LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
INT_VAR                                                                            // initialize variables
"opcode" = "206"                                                                   // effect: #101 (Protection from Opcode)
"target" = "1"                                                                     // target: 1 (self)
"timing" = "9"                                                                     // timing mode: 9 (permanent after death)
"duration" = "0"                                                                   // duration: 0
"sectype" = "0"                                                                    // secondary type: none
"probability1" = "100"                                                             // probability1: 100%
STR_VAR                                                                            // initialize strings
"resource"  = EVALUATE_BUFFER "%spell%"                                            // resref: the current spell
"effsource" = ""                                                                   // effsource: none
END                                                                                // ends FUNCTION
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block



// Quasit

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
             ~DEADDEM2~                                                            // Quasit
              ~DQUAS01~                                                            // Quasit
              ~GORTAN5~                                                            // Quasit
             ~IMPQUA01~                                                            // Quasit
              ~TELQUA1~                                                            // Quasit
              ~TELQUA2~                                                            // Quasit
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE re-indexer macros (needed for corrupt and v1 CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DQUAS~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~RINGDEMN~                                                         // removes RINGDEMN.ITM (Imps are not actual Fiends in 2E)
REMOVE_CRE_ITEM ~REGHP1~                                                           // removes REGHP1.ITM (regeneration now handled via equipped weapon)
WRITE_LONG 0x14 1400
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "24"                                                                  // new hit point value
      "newac"    = "2"                                                                   // new Armor Class value
      "newth"    = "17"                                                                  // new THAC0 value
      "newapr"   = "3"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "25"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "100"                                                                 // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "3"                                                                   // new level (first class)
      "newstr"   = "8"                                                                   // new Strength value
      "newint"   = "7"                                                                   // new Intelligence value
      "newwis"   = "9"                                                                   // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "10"                                                                  // new Constitution value
      "newchr"   = "7"                                                                   // new Charisma value
      "newmor"   = "10"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "60"                                                                  // new morale recovery value
      "newrace"  = "141"                                                                 // new race (Imp)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEADDEM2"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "DQUAS01"                                                             // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "GORTAN5"                                                             // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "IMPQUA01"                                                            // enforced creature 4 (uses strict PnP values)
      "enfc05"   = "TELQUA1"                                                             // enforced creature 5 (uses strict PnP values)
      "enfc06"   = "TELQUA2"                                                             // enforced creature 6 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HQUAS"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "QUASIT"                                                            // fourth AI script name
"script05"   = "QUASIT01"                                                          // 5th AI script name
"script07"   = "BPWDASGT"                                                          // Big Picture script
"script08"   = "DW#MELEE"                                                          // SCSII melee script
"skipfile01" = "TELQUA1"                                                           // skip script patching for a designated file
"skipfile02" = "TELQUA2"                                                           // skip script patching for a designated file
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "98" END                                                // mark opcode #98 (Regeneration) for deletion
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Cambion

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~CAMBION1~                                                           // Cambion
              ~CAMBION2~                                                           // Cambion
              ~IDEMON01~                                                           // Cambion (trapped, non-interactable)
              ~IDEMON02~                                                           // Cambion
               ~ILLCAMB~                                                           // Cambion (illusion?)
              ~ILLCAMB2~                                                           // Cambion (illusion?)
              ~KDEMON01~                                                           // Cambion (illusion?)
              ~DEMOSUM4~                                                           // Cambion
               ~TELCAM1~                                                           // Cambion
               ~GORCAMB~                                                           // Aesgareth (Watcher's Keep Cambion)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REMOVE_CRE_ITEM ~SEEINVIS~                                                         // removes SEEINVIS.ITM (no detect invisibility in PnP)
REMOVE_CRE_ITEM ~HELMNOAN~                                                         // removes HELMNOAN.ITM (no critical hit immunity in PnP)
ADD_CRE_ITEM ~DWDUST~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~ARMOR~                   // unequipp armor in order to enable arcane spellcasting
WRITE_LONG 0x14 6000
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "48"                                                                  // new hit point value
      "newac"    = "2"                                                                   // new Armor Class value
      "newth"    = "15"                                                                  // new THAC0 value
      "newapr"   = "2"                                                                   // new number of attacks per round
      "newsvd"   = "11"                                                                  // new Save vs. Death
      "newsvw"   = "9"                                                                   // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "13"                                                                  // new Save vs. Breath
      "newsvs"   = "10"                                                                  // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "6"                                                                   // new level (first class)
      "newstr"   = "19"                                                                  // new Strength value
      "newint"   = "16"                                                                  // new Intelligence value
      "newwis"   = "8"                                                                   // new Wisdom value
      "newdex"   = "16"                                                                  // new Dexterity value
      "newcon"   = "17"                                                                  // new Constitution value
      "newchr"   = "6"                                                                   // new Charisma value
      "newmor"   = "14"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "1"                                                                   // new class (Mage)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
      "newhide"  = "80"                                                                  // new Hide in Shadows value
      "newmsil"  = "80"                                                                  // new Move Silently value
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "CAMBION1"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "CAMBION2"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "IDEMON01"                                                            // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "IDEMON02"                                                            // enforced creature 4 (uses strict PnP values)
      "enfc05"   = "TELCAM1"                                                             // enforced creature 5 (uses strict PnP values)
       enfc06    = illcamb
       enfc07    = illcamb2
       enfc08    = kdemon01 
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HCAMB"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "CTHIE20B"                                                          // fourth AI script name
"script05"   = "BPDEMTHF"                                                          // Big Picture script
"script06"   = "BPWTRSGT"                                                          // Big Picture script
"script07"   = "BPDEMON"                                                           // Big Picture Demon script
"script08"   = "DW#MELEE"                                                          // SCSII melee script
"skipfile01" = "IDEMON01"                                                          // skip script patching for a designated file
"skipfile02" = "KDEMON01"                                                          // skip script patching for a designated file
"skipfile03" = "GORCAMB"                                                           // skip script patching for a designated file
"skipfile04" = "ILLCAMB"                                                           // skip script patching for a designated file
"skipfile05" = "ILLCAMB2"                                                          // skip script patching for a designated file
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion (no dupl.)
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "292"                                                                     // effect: #292 (Protection from Backstab)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~SPWI106~ #0 ~wizard~                                          // adds 1x Blindness
ADD_MEMORIZED_SPELL ~SPWI106~ #0 ~wizard~                                          // adds 1x Blindness
ADD_MEMORIZED_SPELL ~SPWI112~ #0 ~wizard~                                          // adds 1x Magic Missile
ADD_MEMORIZED_SPELL ~SPWI112~ #0 ~wizard~                                          // adds 1x Magic Missile
ADD_MEMORIZED_SPELL ~SPWI206~ #1 ~wizard~                                          // adds 1x Invisibility
ADD_MEMORIZED_SPELL ~SPWI212~ #1 ~wizard~                                          // adds 1x Mirror Image
ADD_MEMORIZED_SPELL ~SPWI305~ #2 ~wizard~                                          // adds 1x Haste
ADD_MEMORIZED_SPELL ~SPWI312~ #2 ~wizard~                                          // adds 1x Slow
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Alu-Fiend

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~ALUFIE01~                                                           // Alu-Fiend
              ~ALUFIE02~                                                           // Alu-Fiend
              ~GORALU01~                                                           // Alu-Fiend
               ~TELALU1~                                                           // Alu-Fiend
               ~TELSUC1~                                                           // Alu-Fiend
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
WRITE_SHORT 0x28 "25104"                                                           // Sets avatar to MAGE_FEMALE_HUMAN
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REMOVE_CRE_ITEM ~HELMNOAN~                                                         // removes HELMNOAN.ITM (no critical hit immunity in PnP)
ADD_CRE_ITEM ~CLCK14~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~                               // replace armor with a robe to enable arcane spellcasting
WRITE_LONG 0x14 6000
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "48"                                                                  // new hit point value
      "newac"    = "2"                                                                   // new Armor Class value
      "newth"    = "17"                                                                  // new THAC0 value
      "newapr"   = "1"                                                                   // new number of attacks per round
      "newsvd"   = "11"                                                                  // new Save vs. Death
      "newsvw"   = "7"                                                                   // new Save vs. Wand
      "newsvp"   = "9"                                                                   // new Save vs. Polymorph
      "newsvb"   = "11"                                                                  // new Save vs. Breath
      "newsvs"   = "8"                                                                   // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "12"                                                                  // new level (first class)
      "newstr"   = "15"                                                                  // new Strength value
      "newint"   = "18"                                                                  // new Intelligence value
      "newwis"   = "12"                                                                  // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "14"                                                                  // new Constitution value
      "newchr"   = "16"                                                                  // new Charisma value
      "newmor"   = "12"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "1"                                                                   // new class (Mage)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "ALUFIE01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "ALUFIE02"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "GORALU01"                                                            // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "TELALU1"                                                             // enforced creature 4 (uses strict PnP values)
      "enfc05"   = "TELSUC1"                                                             // enforced creature 5 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HALUF"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "CFIGH20B"                                                          // fourth AI script name
"script05"   = "CARCH20B"                                                          // fifth AI script name
"script06"   = "DEMALU01"                                                          // sixth AI script name
"script07"   = "BPCFIG2B"                                                          // Big Picture script
"script07"   = "BPCARC2B"                                                          // Big Picture script
"script08"   = "BPDEMON"                                                           // Big Picture demon script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion (no dupl.)
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "292"                                                                     // effect: #292 (Protection from Backstab)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_KNOWN_SPELL     ~SPWI201~ #1 ~wizard~                                          // add Blur as known
ADD_KNOWN_SPELL     ~SPWI403~ #3 ~wizard~                                          // add Fire Shield (Blue) as known
ADD_KNOWN_SPELL     ~SPWI420~ #3 ~wizard~                                          // add Minor Sequencer as known
ADD_KNOWN_SPELL     ~SPWI522~ #4 ~wizard~                                          // add Minor Spell Turning as known
ADD_KNOWN_SPELL     ~SPWI617~ #5 ~wizard~                                          // add Contingency as known
ADD_MEMORIZED_SPELL ~SPWI106~ #0 ~wizard~                                          // adds 1x Blindness
ADD_MEMORIZED_SPELL ~SPWI106~ #0 ~wizard~                                          // adds 1x Blindness
ADD_MEMORIZED_SPELL ~SPWI112~ #0 ~wizard~                                          // adds 1x Magic Missile
ADD_MEMORIZED_SPELL ~SPWI112~ #0 ~wizard~                                          // adds 1x Magic Missile
ADD_MEMORIZED_SPELL ~SPWI212~ #1 ~wizard~                                          // adds 1x Mirror Image
ADD_MEMORIZED_SPELL ~SPWI212~ #1 ~wizard~                                          // adds 1x Mirror Image
ADD_MEMORIZED_SPELL ~SPWI212~ #1 ~wizard~                                          // adds 1x Mirror Image
ADD_MEMORIZED_SPELL ~SPWI219~ #1 ~wizard~                                          // adds 1x Vocalize
ADD_MEMORIZED_SPELL ~SPWI312~ #2 ~wizard~                                          // adds 1x Slow
ADD_MEMORIZED_SPELL ~SPWI312~ #2 ~wizard~                                          // adds 1x Slow
ADD_MEMORIZED_SPELL ~SPWI314~ #2 ~wizard~                                          // adds 1x Vampiric Touch
ADD_MEMORIZED_SPELL ~SPWI314~ #2 ~wizard~                                          // adds 1x Vampiric Touch
ADD_MEMORIZED_SPELL ~SPWI405~ #3 ~wizard~                                          // adds 1x Improved Invisibility
ADD_MEMORIZED_SPELL ~SPWI405~ #3 ~wizard~                                          // adds 1x Improved Invisibility
ADD_MEMORIZED_SPELL ~SPWI408~ #3 ~wizard~                                          // adds 1x Stoneskin
ADD_MEMORIZED_SPELL ~SPWI408~ #3 ~wizard~                                          // adds 1x Stoneskin
ADD_MEMORIZED_SPELL ~SPWI507~ #4 ~wizard~                                          // adds 1x Hold Monster
ADD_MEMORIZED_SPELL ~SPWI507~ #4 ~wizard~                                          // adds 1x Hold Monster
ADD_MEMORIZED_SPELL ~SPWI508~ #4 ~wizard~                                          // adds 1x Chaos
ADD_MEMORIZED_SPELL ~SPWI508~ #4 ~wizard~                                          // adds 1x Chaos
ADD_MEMORIZED_SPELL ~SPWI611~ #5 ~wizard~                                          // adds 1x Protection From Magical Weapons
WRITE_BYTE 0x275 "2"                                                               // special case, set gender to female
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Maurezhi

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DEMMAU01~                                                           // Maurezhi
               ~GORTAN6~                                                           // Maurezhi (Watcher's Keep Tanar'ri group)
              ~OBSDEM04~                                                           // Maurezhi (Planar Sphere)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REMOVE_CRE_ITEM ~SEEINVIS~                                                         // removes SEEINVIS.ITM (no detect invisibility in PnP)
REMOVE_CRE_ITEM ~HELMNOAN~                                                         // removes HELMNOAN.ITM (no critical hit immunity in PnP)
REPLACE_CRE_ITEM ~RINGDEMN~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                         // replace undead immunities with fiend immunities 
REPLACE_CRE_ITEM ~MAUREZHI~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 6000                                                               //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "45"                                                                  // new hit point value
      "newac"    = "0"                                                                   // new Armor Class value
      "newth"    = "15"                                                                  // new THAC0 value
      "newapr"   = "3"                                                                   // new number of attacks per round
      "newsvd"   = "8"                                                                   // new Save vs. Death
      "newsvw"   = "10"                                                                  // new Save vs. Wand
      "newsvp"   = "9"                                                                   // new Save vs. Polymorph
      "newsvb"   = "9"                                                                   // new Save vs. Breath
      "newsvs"   = "11"                                                                  // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "6"                                                                   // new level (first class)
      "newstr"   = "15"                                                                  // new Strength value
      "newint"   = "16"                                                                  // new Intelligence value
      "newwis"   = "14"                                                                  // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "12"                                                                  // new Constitution value
      "newchr"   = "18"                                                                  // new Charisma value
      "newmor"   = "14"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMMAU01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "GORTAN6"                                                             // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "OBSDEM04"                                                            // enforced creature 3 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HMAUR"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "OBSDEM04"                                                          // fourth AI script name
"script05"   = "DEMMAU01"                                                          // fourth AI script name
"script06"   = "BPPRI10A"                                                          // Big Picture script
"script07"   = "BPDEMON"                                                           // Big Picture demon script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "292" END                                               // mark opcode #292 (Protection from Backstab) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "126"                                                                     // effect: #126 (Movement Modifier)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter1 = "200"                                                                 // param1: 200 (statistic modifier)
  parameter2 = "2"                                                                   // param2: 2 (type: percentage modifier)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
WRITE_SHORT 0x28 "30464"                                                           // special case, standardize Maurezhi apperance (use Ghoul avatar)
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Succubus

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DEMSUC01~                                                           // Succubus
              ~GORSUC01~                                                           // Succubus
               ~GORTAN2~                                                           // Succubus
              ~GORWOM01~                                                           // Nalmissra
                ~KIRINH~                                                           // Kirinhale, the Succubus in Durlag's Tower (BGT)
               ~_KIRINH~                                                           // Kirinhale, the Succubus in Durlag's Tower (Tutu)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
WRITE_LONG 0x14 11000                                                              //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "48"                                                                  // new hit point value
      "newac"    = "0"                                                                   // new Armor Class value
      "newth"    = "15"                                                                  // new THAC0 value
      "newapr"   = "2"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "30"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "6"                                                                   // new level (first class)
      "newstr"   = "15"                                                                  // new Strength value
      "newint"   = "16"                                                                  // new Intelligence value
      "newwis"   = "14"                                                                  // new Wisdom value
      "newdex"   = "17"                                                                  // new Dexterity value
      "newcon"   = "12"                                                                  // new Constitution value
      "newchr"   = "18"                                                                  // new Charisma value
      "newmor"   = "14"                                                                  // new morale value
      "newmorb"  = "5"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newgendr" = "2"                                                                   // new gender (Female)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMSUC01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "GORSUC01"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "GORTAN2"                                                             // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "KIRINH"                                                              // enforced creature 4 (uses strict PnP values)
      "enfc05"   = "_KIRINH"                                                             // enforced creature 5 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HSUCC"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "DEMSUC"                                                            // fourth AI script name
"script05"   = "KIRINH"                                                            // 5th AI script name
"script06"   = "_KIRINH"                                                           // 6th AI script name
"script07"   = "_TASIGHT"                                                          // 7th AI script name
"script08"   = "NALMISS"                                                           // 8th AI script name
"script09"   = "BPDEMON"                                                           // Big Picture demon script
"script10"   = "INITDLG"                                                           // dialogue initialization script (BGT Kirinhale)
"script11"   = "_INITDLG"                                                          // dialogue initialization script (Tutu Kirinhale)
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~_KIRINH~) BEGIN                        // special case, Tutu's Kirinhale needs a proper immunity item
  REPLACE_CRE_ITEM ~RINGDEMN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~LRING~           // replace the Tutu fiend immunty ring with the BG2 version
  ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~RRING~                // add immunity to +1 weapons and below
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~KIRINH~) BEGIN                         // special case, BGT's Kirinhale needs a proper immunity item
  ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~RRING~                // add immunity to +1 weapons and below
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Nabassu

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DEMNAB01~                                                           // Nabassu
              ~DEMNAB02~                                                           // Nabassu
//            ~ENDDEM04~                                                           // Nabassu (unused?)
//            ~ENDDEM05~                                                           // Nabassu (unused?)
              ~OBSDEM01~                                                           // Lea'liyl (named Nabassu within the Planar Sphere)
              ~OBSDEM05~                                                           // Nabassu (cutscene only?)
//             ~PPNAB01~                                                           // Nabassu (cutscene only?)
//             ~PPNAB02~                                                           // Nabassu (cutscene only?)
//             ~PPNAB03~                                                           // Nabassu
               ~PMASTER~                                                           // Master of Thralls (named Nabassu within the Planar Prison)
               ~RUMAR02~                                                           // Nabassu
                ~UDNABA~                                                           // Nabassu
              ~ABYDEM01~                                                           // Tanar'ri (Nabassu within the Planar Sphere)
              ~TANARI01~                                                           // Tanar'ri (Nabassu within the Planar Sphere)
                 ~TANAR~                                                           // Aec'Letec (BGT)
                ~_TANAR~                                                           // Aec'Letec (Tutu)
                demnabsu                                                           //Summoned Nabassu  
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DNABA~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 16000                                                              //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "76"                                                                  // new hit point value
      "newac"    = "-5"                                                                  // new Armor Class value
      "newth"    = "13"                                                                  // new THAC0 value
      "newapr"   = "3"                                                                   // new number of attacks per round
      "newsvd"   = "10"                                                                  // new Save vs. Death
      "newsvw"   = "12"                                                                  // new Save vs. Wand
      "newsvp"   = "11"                                                                  // new Save vs. Polymorph
      "newsvb"   = "12"                                                                  // new Save vs. Breath
      "newsvs"   = "13"                                                                  // new Save vs. Spell
      "newmr"    = "50"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "7"                                                                   // new level (first class)
      "newstr"   = "19"                                                                  // new Strength value
      "newint"   = "14"                                                                  // new Intelligence value
      "newwis"   = "15"                                                                  // new Wisdom value
      "newdex"   = "14"                                                                  // new Dexterity value
      "newcon"   = "19"                                                                  // new Constitution value
      "newchr"   = "18"                                                                  // new Charisma value
      "newmor"   = "16"                                                                  // new morale value
      "newmorb"  = "4"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMNAB01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "DEMNAB02"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "UDNABA"                                                              // enforced creature 3 (uses strict PnP values)
       enfc04    =  demnabsu
       enfc05    = rumar02
       enfc06    = obsdem05
       enfc07    = abydem01
       enfc08    = tanari01
  END                                                                                // ends FUNCTION call
END
PATCH_IF "%file%" STRING_COMPARE_CASE demnabsu BEGIN
  LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
    STR_VAR                                                                            // Initialize strings
      "newscript"  = "rr#hnaba"                                                          // new AI script
      "script01"   = ""                                                                  // first AI script name
      "script02"   = "None"                                                              // second AI script name
      "script03"   = "WTASIGHT"                                                          // third AI script name
      "script04"   = "SUMTAN01"                                                          // fourth AI script name
      "script05"   = "TANARI2"                                                           // fifth AI script name
      "script06"   = "TANARI"                                                            // sixth AI script name
      "script07"   = "DEMNAB02"                                                          // seventh AI script name
      "script08"   = "_TANARI"                                                           // 8th AI script name
      "script09"   = "_TASIGHT"                                                          // 9th AI script name
      "script10"   = "BGTANARI"                                                          // 10th AI script name
      "script11"   = "BPDEMON"                                                           // Big Picture demon script
      "script12"   = "BPTANARI"                                                          // Big Picture script
      "script13"   = "DW#MELEE"                                                          // SCSII melee script
  END                                                                                // ends FUNCTION call
END
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "193" END                                               // mark opcode #193 (Invisible Detection by Script) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells (prevents AI quirks)
            ~SPIN561~                                                              // Fire Giant Lava Pit (FIRE_GIANT_LAVA)
            ~SPIN819~                                                              // Lava Burst (LAVA_BURST)
            ~SPWI022~                                                              // Lava Pit (TRAP_MUCK)
            ~SPWI103~                                                              // Burning Hands
            ~SPWI217~                                                              // Agannazar's Scorcher
            ~SPWI304~                                                              // Fireball
            ~SPWI308~                                                              // Lightning Bolt (Tanar'ri only)
            ~SPWI502~                                                              // Cloudkill
            ~SPWI523~                                                              // Sunfire
            ~SPWI712~                                                              // Delayed Blast Fireball
            ~SPWI810~                                                              // Incendiary Cloud
            ~SPWI911~                                                              // Meteor Swarm
            ~SPPR705~                                                              // Fire Storm
            ~RR#PR211~                                                             // Nabassu's own Silence 15' Radius
BEGIN                                                                              // execute the following
LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
INT_VAR                                                                            // initialize variables
"opcode" = "206"                                                                   // effect: #101 (Protection from Opcode)
"target" = "1"                                                                     // target: 1 (self)
"timing" = "9"                                                                     // timing mode: 9 (permanent after death)
"duration" = "0"                                                                   // duration: 0
"sectype" = "0"                                                                    // secondary type: none
"probability1" = "100"                                                             // probability1: 100%
STR_VAR                                                                            // initialize strings
"resource"  = EVALUATE_BUFFER "%spell%"                                            // resref: the current spell
"effsource" = ""                                                                   // effsource: none
END                                                                                // ends FUNCTION
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~_TANAR~) BEGIN                         // special case, Tutu's Aec'Letec needs a proper immunity item
  REPLACE_CRE_ITEM ~RINGDEMN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~LRING~           // replace the Tutu fiend immunty ring with the BG2 version
  WRITE_LONG 0x14 0                                                                // XP value nulled as it's handled via script for Aec'Letec
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~TANAR~) BEGIN                          // special case, Aec'Letec's XP value on BGT
  WRITE_LONG 0x14 0                                                                // XP value nulled as it's handled via script for Aec'Letec
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Glabrezu

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DEMGLA01~                                                           // Glabrezu
               ~DEMGLAB~                                                           // Glabrezu
              ~DEMGLAB2~                                                           // Glabrezu
              ~DEMOSUM3~                                                           // Glabrezu
               ~DGLAB01~                                                           // Glabrezu
//            ~ENDDEM01~                                                           // Glabrezu (unused?)
//            ~ENDDEM02~                                                           // Glabrezu (unused?)
//            ~ENDDEM02~                                                           // Glabrezu (unused?)
               ~GORTAN4~                                                           // Glabrezu
              ~JONDEM01~                                                           // Glabrezu
              ~JONDEM03~                                                           // Glabrezu
              ~JONDEM05~                                                           // Glabrezu
              ~MELSUM01~                                                           // Glabrezu
               ~TELTAN1~                                                           // Glabrezu
               ~TELTAN2~                                                           // Glabrezu
               demglasu                                                            //Summoned Glabrezu  
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DGLAB~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 12000                                                              //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "80"                                                                  // new hit point value
      "newac"    = "-7"                                                                  // new Armor Class value
      "newth"    = "11"                                                                  // new THAC0 value
      "newapr"   = "5"                                                                   // new number of attacks per round
      "newsvd"   = "8"                                                                   // new Save vs. Death
      "newsvw"   = "10"                                                                  // new Save vs. Wand
      "newsvp"   = "9"                                                                   // new Save vs. Polymorph
      "newsvb"   = "9"                                                                   // new Save vs. Breath
      "newsvs"   = "11"                                                                  // new Save vs. Spell
      "newmr"    = "50"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newar"    = "100"                                                                 // new Resist Acid value
      "newlvl1"  = "10"                                                                  // new level (first class)
      "newstr"   = "20"                                                                  // new Strength value
      "newint"   = "16"                                                                  // new Intelligence value
      "newwis"   = "13"                                                                  // new Wisdom value
      "newdex"   = "18"                                                                  // new Dexterity value
      "newcon"   = "20"                                                                  // new Constitution value
      "newchr"   = "22"                                                                  // new Charisma value
      "newmor"   = "18"                                                                  // new morale value
      "newmorb"  = "3"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMGLA01"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "DEMGLAB"                                                             // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "DGLAB01"                                                             // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "TELTAN1"                                                             // enforced creature 4 (uses strict PnP values)
      "enfc05"   = "TELTAN2"                                                             // enforced creature 5 (uses strict PnP values)
       enfc06    =  demglasu 
       enfc07    = demglab2
       enfc08    = gortan4
       emfc09    = jondem01
       emfc10    = jondem03
       enfc11    = jondem05  
  END                                                                                // ends FUNCTION call
END
PATCH_IF "%file%" STRING_COMPARE_CASE demglasu BEGIN
  LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
    STR_VAR                                                                            // Initialize strings
      "newscript"  = "rr#hglab"                                                          // new AI script
      "script01"   = ""                                                                  // 1st AI script name
      "script02"   = "None"                                                              // 2nd AI script name
      "script03"   = "WTASIGHT"                                                          // 3rd AI script name
      "script04"   = "MELGLAB"                                                           // 4th AI script name
      "script05"   = "DEMGLAB"                                                           // 5th AI script name
      "script06"   = "DEMGLAB2"                                                          // 6th AI script name
      "script07"   = "GLABREZ"                                                           // 7th AI script name
      "script08"   = "DEMGAJ"                                                            // 8th AI script name
      "script09"   = "TELTAN1"                                                           // 9th AI script name
      "script10"   = "TELTAN2"                                                           // 10th AI script name
      "script11"   = "TANARI"                                                            // 11th AI script name
      "script12"   = "BPDEMON"                                                           // Big Picture demon script
      "script13"   = "DW#MELEE"                                                          // SCSII melee script
  END                                                                                // ends FUNCTION call
END
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
WRITE_SHORT 0x28 "57585"                                                           // special case, Glabrezu should use the IC_GLAB avatar
PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells (prevents AI quirks)
            ~SPIN561~                                                              // Fire Giant Lava Pit (FIRE_GIANT_LAVA)
            ~SPIN819~                                                              // Lava Burst (LAVA_BURST)
            ~SPWI022~                                                              // Lava Pit (TRAP_MUCK)
            ~SPWI103~                                                              // Burning Hands
            ~SPWI217~                                                              // Agannazar's Scorcher
            ~SPWI304~                                                              // Fireball
            ~SPWI308~                                                              // Lightning Bolt (Tanar'ri only)
            ~SPWI502~                                                              // Cloudkill
            ~SPWI523~                                                              // Sunfire
            ~SPWI614~                                                              // Death Fog (Glabrezu only)
            ~SPWI712~                                                              // Delayed Blast Fireball
            ~SPWI810~                                                              // Incendiary Cloud
            ~SPWI911~                                                              // Meteor Swarm
            ~SPPR705~                                                              // Fire Storm
BEGIN                                                                              // execute the following
LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
INT_VAR                                                                            // initialize variables
"opcode" = "206"                                                                   // effect: #101 (Protection from Opcode)
"target" = "1"                                                                     // target: 1 (self)
"timing" = "9"                                                                     // timing mode: 9 (permanent after death)
"duration" = "0"                                                                   // duration: 0
"sectype" = "0"                                                                    // secondary type: none
"probability1" = "100"                                                             // probability1: 100%
STR_VAR                                                                            // initialize strings
"resource"  = EVALUATE_BUFFER "%spell%"                                            // resref: the current spell
"effsource" = ""                                                                   // effsource: none
END                                                                                // ends FUNCTION
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Marilith

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~DEMOSUM1~                                                           // Marilith
              ~ICMARILI~                                                           // Marilith (no animation)
              ~MELSUM05~                                                           // Marilith
              ~GORWOM03~                                                           // Y'tossi (Watcher's Keep final seal Huntress' party)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DMARI~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
ADD_CRE_ITEM ~IPSION~ #0 #0 #0 ~UNDROPPABLE~ ~AMULET~                              // add protection from all mind-affecting spells
WRITE_LONG 0x14 23000                                                              //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "96"                                                                  // new hit point value
      "newac"    = "-9"                                                                  // new Armor Class value
      "newapr"   = "1"                                                                   // new number of attacks per round
      "newsvd"   = "5"                                                                   // new Save vs. Death
      "newsvw"   = "7"                                                                   // new Save vs. Wand
      "newsvp"   = "6"                                                                   // new Save vs. Polymorph
      "newsvb"   = "5"                                                                   // new Save vs. Breath
      "newsvs"   = "8"                                                                   // new Save vs. Spell
      "newmr"    = "70"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "13"                                                                  // new level (first class)
      "newstr"   = "19"                                                                  // new Strength value
      "newint"   = "18"                                                                  // new Intelligence value
      "newwis"   = "15"                                                                  // new Wisdom value
      "newdex"   = "18"                                                                  // new Dexterity value
      "newcon"   = "12"                                                                  // new Constitution value
      "newchr"   = "20"                                                                  // new Charisma value
      "newmor"   = "18"                                                                  // new morale value
      "newmorb"  = "3"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "DEMOSUM1"                                                            // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "ICMARILI"                                                            // enforced creature 2 (uses strict PnP values)
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HMARI"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "ICMARILI"                                                          // fourth AI script name
"script05"   = "MELMARI"                                                           // fifth AI script name
"script06"   = "MARILITH"                                                          // sixth AI script name
"script07"   = "YTOSSI"                                                            // seventh AI script name
"script08"   = "BPDEMON"                                                           // Big Picture demon script
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "1" END                                                 // mark opcode #1 (Attacks Per Round Modifier) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "16" END                                                // mark opcode #16 (Haste) for deletion
  LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~                                          // delete the EFF with the designated opcode
  INT_VAR opcode_to_delete = "98" END                                                // mark opcode #98 (Regeneration) for deletion
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
INT_VAR
opcode = "206"                                                                     // effect: #206 (Protection from Spell)
target = "1"                                                                       // target: 1 (self)
timing = "9"                                                                       // timing mode: 9 (permanent after death)
"duration" = "0"                                                                   // duration: 0
"sectype" = "0"                                                                    // secondary type: none
probability1 = "100"                                                               // probability1: 100%
STR_VAR
"resource"  = "RR#WI502"                                                           // resref: RR#WI302.SPL (Marilith's own Cloudkill)
"effsource" = ""                                                                   // effsource: none
END
WRITE_BYTE  0x2E "26"                                                              // major color (wood)
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block



// Balor

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
               ~BALOR01~                                                           // Balor
              ~DEMBAL01~                                                           // Balor
              ~DEMBAL02~                                                           // Balor
              ~DEMOSUM2~                                                           // Balor
//            ~ENDDEM03~                                                           // Balor (unused?)
                ~GORDEM~                                                           // Balor (mismatched animation fixed)
              ~GORDEMC1~                                                           // Balor (cutscene only)
              ~JONDEM02~                                                           // Balor (mismatched animation fixed)
              ~JONDEM04~                                                           // Balor (mismatched animation fixed)
              ~M05DEMON~                                                           // Balor (cutscene only)
              ~MELSUM04~                                                           // Balor
               ~SUDEMON~                                                           // Balor
              ~SUDEMON2~                                                           // Balor
              ~SUDEMDE1~                                                           // Balor
              ~SUDEMDE2~                                                           // Balor
               ~SUDEMW1~                                                           // Balor
               ~TELBAL1~                                                           // Balor
               ~TELBAL2~                                                           // Balor
               ~UDBALOR~                                                           // Balor
               ~GORTAN1~                                                           // Tahazzar (Watcher's Keep Tanar'ri leader)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
REMOVE_CRE_ITEM ~DW#SUMFI~                                                         // removes DW#SUMFI.ITM (SCSII's fiend immunities, prevents conflict)
REPLACE_CRE_ITEM ~RR#DBALR~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a less powerful weapon (closer to PnP damage output)
WRITE_LONG 0x14 26000                                                              //XP
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
    INT_VAR                                                                            // Initialize variables
      "newhp"    = "104"                                                                 // new hit point value
      "newac"    = "-8"                                                                  // new Armor Class value
      "newapr"   = "2"                                                                   // new number of attacks per round
      "newsvd"   = "5"                                                                   // new Save vs. Death
      "newsvw"   = "7"                                                                   // new Save vs. Wand
      "newsvp"   = "6"                                                                   // new Save vs. Polymorph
      "newsvb"   = "5"                                                                   // new Save vs. Breath
      "newsvs"   = "8"                                                                   // new Save vs. Spell
      "newmr"    = "70"                                                                  // new Magic Resistance value
      "newfr"    = "100"                                                                 // new Resist Fire value
      "newcr"    = "50"                                                                  // new Resist Cold value
      "newer"    = "100"                                                                 // new Resist Electricity value
      "newlvl1"  = "20"                                                                  // new level (first class)
      "newstr"   = "21"                                                                  // new Strength value
      "newint"   = "20"                                                                  // new Intelligence value
      "newwis"   = "16"                                                                  // new Wisdom value
      "newdex"   = "18"                                                                  // new Dexterity value
      "newcon"   = "20"                                                                  // new Constitution value
      "newchr"   = "25"                                                                  // new Charisma value
      "newmor"   = "18"                                                                  // new morale value
      "newmorb"  = "3"                                                                   // new morale break value
      "newmorr"  = "15"                                                                  // new morale recovery value
      "newrace"  = "121"                                                                 // new race (Demonic)
      "newclass" = "160"                                                                 // new class (Tanari)
      "newalign" = "51"                                                                  // new alignment (Chaotic Evil)
    STR_VAR                                                                            // initialize strings
      "enfc01"   = "BALOR01"                                                             // enforced creature 1 (uses strict PnP values)
      "enfc02"   = "DEMBAL01"                                                            // enforced creature 2 (uses strict PnP values)
      "enfc03"   = "DEMBAL02"                                                            // enforced creature 3 (uses strict PnP values)
      "enfc04"   = "UDBALOR"                                                             // enforced creature 4 (uses strict PnP values)
       enfc05    = telbal1
       enfc06    = telbal2 
       enfc07    = gordem
       enfc08    = gordemc1
       enfc09    = jondem02
       enfc10    = jondem04 
       enfc11    = sudemon
       enfc12    = sudemon2
       enfc13    = sudemde1
       enfc14    = sudemde2
       enfc15    = sudemw1
  END                                                                                // ends FUNCTION call
END
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#HBALR"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // third AI script name
"script04"   = "BALOR01"                                                           // fourth AI script name
"script05"   = "DEMBAL01"                                                          // fifth AI script name
"script06"   = "DEMBAL02"                                                          // sixth AI script name
"script07"   = "DEMOSUM2"                                                          // seventh AI script name
"script08"   = "ROCKROOM"                                                          // 8th AI script name
"script09"   = "TELBAL01"                                                          // 9th AI script name
"script10"   = "MELBALOR"                                                          // 10th AI script name
"script11"   = "SUDEMON"                                                           // 11th AI script name
"script12"   = "ATTKNEU2"                                                          // 12th AI script name
"script13"   = "DEMPTJ"                                                            // 13th AI script name
"script14"   = "TANARI"                                                            // 14th AI script name
"script15"   = "BPDEMON"                                                           // Big Picture demon script
"script16"   = "DW#MELEE"                                                          // SCSII melee script
"skipfile01" = "GORTAN1"                                                           // skip script patching for a designated file
"skipfile02" = "M05DEMON"                                                          // skip script patching for a designated file
"skipfile03" = "GORDEMC1"                                                          // skip script patching for a designated file
END                                                                                // ends FUNCTION call
PATCH_IF FiendsScripts = 0 BEGIN                                                   //Only do this if we're not just adding aTweaks scripting
  LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
  opcode = "300"                                                                     // effect: #300 (NPC Bump)
  target = "1"                                                                       // target: 1 (self)
  timing = "9"                                                                       // timing mode: 9 (permanent after death)
  "duration" = "0"                                                                   // duration: 0
  "sectype" = "0"                                                                    // secondary type: none
  parameter2 = "1"                                                                   // param2: 1 (constant value)
  probability1 = "100"                                                               // probability1: 100%
  STR_VAR
  "effsource" = ""                                                                   // effsource: none
  END
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~BALOR01~) BEGIN                        // special case, an (unused?) Balor should be flagged as hostile
WRITE_BYTE  0x270 "255"                                                            // set initial allegiance to ENEMY
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~DEMBAL01~) BEGIN                       // special case, an (unused?) Balor should be flagged as hostile
WRITE_BYTE  0x270 "255"                                                            // set initial allegiance to ENEMY
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file validity check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block



// Gelugon
   

COPY ~atweaks/cre/RR#SGELU.CRE~ ~override/RR#HGEL.CRE~                             // Gelugon (hostile)
  PATCH_IF FiendsScripts BEGIN                                                       //If we are using existing values for stats, copy HP from Glabrezus
    INNER_ACTION BEGIN
      COPY_EXISTING demglasu.cre override
        READ_SHORT 0x26 newhp
      BUT_ONLY
    END
    LPF RR#MDCRE
      INT_VAR
        newhp
    END
  END 
  SAY NAME1 @670 SAY NAME2 @670
  WRITE_LONG  0x14 "19000"                                                         // XP value
  WRITE_ASCII 0x248 ~RR#HGELU~ #8                                                  // override AI script
  WRITE_BYTE  0x270 "255"                                                          // set initial allegiance to ENEMY
  WRITE_ASCII 0x280 ~RR#HGELU~ #32                                                 // assign new death variable

COPY_EXISTING ~AR3004.ARE~ ~override~                                              // Watcher's Keep maze
  REPLACE_TEXTUALLY CASE_INSENSITIVE "GORDEM2" "RR#HGEL"                           // replace Velithuu with Gelugon (note: name lengths must be the same)
BUT_ONLY_IF_IT_CHANGES



/*
//////////
//Yugoloth
//////////

//Ultroloth

WRITE_LONG 0x14
LAUNCH_PATCH_FUNCTION RR#MDCRE
  INT_VAR
    newhp        = 130
    newac        = "-8"
    newth        = 7
    mewapr       = 2
    newsvd       = 
    newsvw       = 
    newsvp       =
    newsvb       = 
    newsvs       = 
    newmr        = 60
    newfr        = 100
    newcr        = "-100"
    newer        = 0
    newar        = 100
    newstr       = 21
    newint       = 20
    newmor       = 16
    newalign     = 19
    
    
//Nycaloth
COPY_EXISTING telbal1.cre "override/fl#snyca.cre"
PATCH_INCLUDE ~aTweaks/lib/fj_cre_validity.tpp~                                    // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
PATCH_IF valid BEGIN
  PATCH_INCLUDE ~aTweaks/lib/fj_cre_reindex.tpp~                                   // Nythrun's CRE reindex macro (this also calls the EFF macro if needed)
// =============================================================================== // the actual work starts from here
  SAY NAME1 @734 SAY NAME2 @734                                                    //Nycaloth   
  REPLACE_CRE_ITEM fl#nyca #0 #0 #0 unstealable&undroppable weapon1 EQUIP
  REPLACE_CRE_ITEM immune2 #0 #0 #0 none lring
  WRITE_LONG 0x14
  LAUNCH_PATCH_FUNCTION RR#MDCRE
    INT_VAR
      newhp        = 110
      newac        = "-6"
      newth        = 9
      newapr       = 2
      newsvd       = 8
      newsvw       = 10
      newsvp       = 9
      newsvb       = 9
      newsvs       = 11
      newlvl1      = 11
      newmr        = 70
      newfr        = 100
      newcr        = "-100"
      newer        = 0
      newar        = 100 
      newstr       = 20
      newint       = 18 
      newmor       = 16
      newalign     = 19 //NE
      
      enforce      = 1
    

//Arcanaloth

WRITE_LONG 0x14
LAUNCH_PATCH_FUNCTION RR#MDCRE
  INT_VAR
    newhp        = 120
    newac        = "-8"
    newth        = 9
    newapr       = 3
    newsvd       = 
    newsvw       = 
    newsvp       = 
    newsvb       = 
    newsvs       = 
    newlvl1      = 12
    newmr        = 60
    newfr        = 100
    newcr        = "-100"
    newer        = 0
    newar        = 100 
    newstr       = 18
    newint       = 20 
    newmor       = 16
    newalign     = 19 //NE
    newclass     = 1 //Mage
END
ADD_MEMORIZED_SPELL spwi114 #0 wizard      //Shield
ADD_MEMORIZED_SPELL spwi118 #0 wizard      //Chromatic Orb
ADD_MEMORIZED_SPELL spwi106 #0 wizard      //Blindness
ADD_MEMORIZED_SPELL spwi125 #0 wizard      //Spook
ADD_MEMORIZED_SPELL spwi212 #1 wizard      //Mirror Image 
ADD_MEMORIZED_SPELL spwi211 #1 wizard (2)  //Melf's Acid Arrow
ADD_MEMORIZED_SPELL spwi205 #1 wizard      //Horror
ADD_MEMORIZED_SPELL spwi303 #2 wizard      //Flame Arrow
ADD_MEMORIZED_SPELL spwi320 #2 wizard      //Protection From Cold
ADD_MEMORIZED_SPELL spwi325 #2 wizard (2)  //Melf's Minute Meteors
ADD_MEMORIZED_SPELL spwi408 #3 wizard (2)  //Stoneskin
ADD_MEMORIZED_SPELL spwi419 #3 wizard      //Secret Word
ADD_MEMORIZED_SPELL spwi412 #3 wizard      //Greater Malison
ADD_MEMORIZED_SPELL spwi507 #4 wizard      //Hold Monster
ADD_MEMORIZED_SPELL spwi506 #4 wizard      //Domination
ADD_MEMORIZED_SPELL spwi513 #4 wizard      //Breach
ADD_MEMORIZED_SPELL spwi508 #4 wizard      //Chaos
ADD_MEMORIZED_SPELL spwi615 #5 wizard      //Chain Lightning

//fear, 1x/day
//invisibility
//magic missile
//telekinesis
//mage of 12th level
//They all have this:
//animate dead
//cause disease
//charm person
//produce flame
//teleport without error


*/

//Create scripts and creatures outside the ACTION_IF in case SCSII is installed after 
COMPILE ~atweaks/baf/fiends/fl#nabsu.baf~
        ~atweaks/baf/fiends/fl#corsu.baf~
        ~atweaks/baf/fiends/fl#glasu.baf~
        ~atweaks/baf/fiends/fl#gelsu.baf~
        ~atweaks/baf/fiends/fl#balsu.baf~
        ~atweaks/baf/fiends/fl#pitsu.baf~
        
COPY_EXISTING ~demnabsu.cre~ ~override/fl#nabsu.cre~
              ~telcor1.cre~  ~override/fl#corsu.cre~
              ~demglasu.cre~ ~override/fl#glasu.cre~
              ~rr#hgel.cre~  ~override/fl#gelsu.cre~
              ~telbal1.cre~  ~override/fl#balsu.cre~
              ~dempitsu.cre~ ~override/fl#pitsu.cre~
  WRITE_LONG 0x10 2                                                                // clear flags, leave only "no corpse"
  WRITE_ASCIIE 0x248 "%DEST_RES%" #8                                               // summoned script
  WRITE_ASCII  0x250 ~~ #8                                                         // disable class AI script
  WRITE_ASCII  0x258 ~~ #8                                                         // disable race AI script
  WRITE_ASCII  0x260 ~~ #8                                                         // disable general AI script
  WRITE_ASCII  0x268 ~~ #8                                                         // disable default AI script
  WRITE_BYTE   0x270 255                                                           //Enemy                                                                                                                                  
  WRITE_BYTE   0x275 1                                                             //Male 
  WRITE_ASCII  0x280 ~~ #32                                                        //no script name 
  READ_LONG 0x2bc io
  FOR (i=0;i<LONG_AT 0x2c0;++i) BEGIN                                              //Make all items unstealable&undroppable
    WRITE_BYTE io + 0x14*i + 0x10 THIS BOR 10
  END
  PATCH_IF FILE_EXISTS_IN_GAME dw#sumfi.itm AND !FILE_CONTAINS_EVALUATED ("%SOURCE_FILE%" "dw#sumfi") BEGIN
    ADD_CRE_ITEM "dw#sumfi" #0 #0 #0 none boots
  END

//Commandeer SCSII's private fiend-summoning spells and have them summon SCSII-aTweaks hybrids
ACTION_IF FILE_EXISTS_IN_GAME dw#cacof.spl AND !FiendsOriginal BEGIN //FiendsOriginal eq "do not alter mod-added fiends"
   
  OUTER_SPRINT $crefile("dw#cacof") "fl#nabsu"
  OUTER_SPRINT $crefile("dw#sumbf") "fl#corsu"  
  OUTER_SPRINT $crefile("dw#sumgl") "fl#glasu"
  OUTER_SPRINT $crefile("dw#sumco") "fl#gelsu"
  OUTER_SPRINT $crefile("dw#basum") "fl#balsu"
  OUTER_SPRINT $crefile("dw#pitsu") "fl#pitsu"
    
  COPY_EXISTING "dw#cacof.eff" override
                "dw#sumbf.eff" override
                "dw#sumgl.eff" override
                "dw#sumco.eff" override
                "dw#basum.eff" override
                "dw#pitsu.eff" override
    WRITE_ASCIIE 0x30 $crefile("%SOURCE_RES%") #8
  BUT_ONLY
END 


// New AI Scripts

COMPILE ~aTweaks/BAF/fiends/RR#HQUAS.BAF~                                                 // Hostile Quasit AI script
COMPILE ~aTweaks/BAF/fiends/RR#HALUF.BAF~                                                 // Hostile Alu-Fiend AI script
COMPILE ~aTweaks/BAF/fiends/RR#HCAMB.BAF~                                                 // Hostile Cambion AI script
COMPILE ~aTweaks/BAF/fiends/RR#HMAUR.BAF~                                                 // Hostile Maurezhi AI script
COMPILE ~aTweaks/BAF/fiends/RR#HSUCC.BAF~                                                 // Hostile Succubus AI script
COMPILE ~aTweaks/BAF/fiends/RR#HNABA.BAF~                                                 // Hostile Nabassu AI script
COMPILE ~aTweaks/BAF/fiends/RR#HGLAB.BAF~                                                 // Hostile Glabrezu AI script
COMPILE ~aTweaks/BAF/fiends/RR#HMARI.BAF~                                                 // Hostile Marilith AI script
COMPILE ~aTweaks/BAF/fiends/RR#HBALR.BAF~                                                 // Hostile Balor AI script
COMPILE ~aTweaks/BAF/fiends/RR#HIMP.BAF~                                                  // Hostile Imp AI script
COMPILE ~aTweaks/BAF/fiends/RR#HFCAT.BAF~                                                 // Hostile Hellcat AI script
COMPILE ~aTweaks/BAF/fiends/RR#HERIN.BAF~                                                 // Hostile Erinyes AI script
COMPILE ~aTweaks/BAF/fiends/RR#HBFND.BAF~                                                 // Hostile Bone Fiend AI script
COMPILE ~aTweaks/BAF/fiends/RR#HABIS.BAF~                                                 // Hostile Abishai AI script
COMPILE ~aTweaks/BAF/fiends/RR#HCORN.BAF~                                                 // Hostile Cornugon AI script
COMPILE ~aTweaks/BAF/fiends/RR#HGELU.BAF~                                                 // Hostile Gelugon AI script
COMPILE ~aTweaks/BAF/fiends/RR#HPITF.BAF~                                                 // Hostile Pit Fiend AI script
COMPILE ~aTweaks/BAF/fiends/RR#KARAS.BAF~                                                 // Ka'rashur's reinforcement summoning script
COMPILE ~aTweaks/BAF/fiends/RR#TAHAZ.BAF~                                                 // Tahazzar's reinforcement summoning script

EXTEND_TOP ~KARASH.BCS~ ~aTweaks/BAF/fiends/KARASH.BAF~                                   // make Ka'rashur use aTweaks' Pit Fiend script once he goes hostile
EXTEND_TOP ~TAHAZZ.BCS~ ~aTweaks/BAF/fiends/TAHAZZ.BAF~                                   // make Tahazzar use aTweaks' Balor script once he goes hostile

COPY_EXISTING ~KETTAATK.BCS~ ~override~                                            // fix the Glabrezu spawning in the Guarded Compound
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~ForceSpell(LastTrigger(Myself),WIZARD_SUMMON_FIEND)~ ~CreateCreatureObject("DEMGLA01",LastTrigger(Myself),0,0,0)~
  REPLACE_TEXTUALLY EXACT_MATCH ~ForceSpellRES("dw#sumgl",LastTrigger(Myself))~ ~CreateCreatureObject("DEMGLA01",LastTrigger(Myself),0,0,0)~ // SCSII
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~CUT215A.BCS~ ~override~                                             // Succubus Kiss cutscene in Watcher's Keep maze
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~ActionOverride("gorsuc01",ForceSpell(Player1,PHASE_SPIDER_TELEPORT))~ ~ActionOverride("gorsuc01",ForceSpellRES("RR#TELWE",Player1))~ // Teleport Without Error
  REPLACE_TEXTUALLY EXACT_MATCH ~ActionOverride("gorsuc01",ForceSpell(Player1,SUCCUBUS_KISS))~ ~ActionOverride("gorsuc01",ForceSpellRES("RR#SKISS",Player1))~ // Kiss
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~GORSUCCU.BCS~ ~override~                                             // Watcher's Keep Succubus escape script
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~ForceSpell(Myself,DRYAD_TELEPORT)~ ~ForceSpellRES("RR#TELAW",Myself)~ // Teleport away
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~TELQUA1.BCS~ ~override~                                             // Watcher's Keep Quasit script (Wild Magic room)
              ~TELQUA2.BCS~ ~override~                                             // Watcher's Keep Quasit script (Wild Magic room)
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~ApplySpell(Myself,WIZARD_INVISIBILITY)~ ~SpellNoDec(Myself,WIZARD_INVISIBILITY)~ // Prevent annoying perma-invisibility
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES

//Fix minhp items so the wearer can't be killed by the Nabassu's Death Gaze
COPY_EXISTING ABAZRING.ITM override
              BHAALHP1.ITM override
              FINMEL01.ITM override
              GORFIRG.ITM override
              ICEREGEN.ITM override
              IMOENHP1.ITM override
              JONHP1.ITM override
              MEL01.ITM override
              MINHP1.ITM override
              MINHP20.ITM override
              MINHP60.ITM override
              MONHP01.ITM override
              MONHP1.ITM override
              MONHP20.ITM override
              MONHP80.ITM override
              SENGUA04.ITM override
              SUREHP1.ITM override
              TSTATUE.ITM override
  PATCH_IF SOURCE_SIZE > 0x71 BEGIN
    LPF ADD_ITEM_EQEFFECT 
      INT_VAR
        opcode = 206
        target = 1
        timing = 2
      STR_VAR
        resource = rr#dgaze
    END
  END
BUT_ONLY


//Account for Spell Revisions being incompatible with aTweaks
ACTION_IF MOD_IS_INSTALLED spell_rev.tp2 0 BEGIN
  COPY_EXISTING spcl213.spl override
                spcl233.spl override
                sppr107.spl override
                sppr408.spl override
                spwi113.spl override
    PATCH_IF SOURCE_SIZE > 0x71 BEGIN
      READ_LONG  0x64 ao
      READ_LONG  0x6a eo
      READ_SHORT 0x70 ei
      FOR (i=0;i<SHORT_AT 0x68;++i) BEGIN
        WRITE_SHORT ao + 0x28*i + 0x20 ei
        READ_SHORT  ao + 0x28*i + 0x1e ne
        FOR (j=0;j<ne;++j) BEGIN
          READ_SHORT eo + 0x30*(ei + j) type
          PATCH_IF type = 219 BEGIN
            READ_ASCII     eo + 0x30*(ei + j)       copy (0x30)
            INSERT_BYTES   eo + 0x30*(ei + j)       0x30
              WRITE_ASCIIE eo + 0x30*(ei + j)       "%copy%"
              WRITE_SHORT  eo + 0x30*(ei + j)       100
              WRITE_LONG   eo + 0x30*(ei + j) + 0x4 9
              WRITE_LONG   eo + 0x30*(ei + j) + 0x8 7
            ++ne
            j=ne
          END
        END
        WRITE_SHORT ao + 0x28*i + 0x1e ne
        ei += ne
      END
    END
  BUT_ONLY
END

// Creature changes

OUTER_SPRINT $sscript(demnabsu)   rr#snaba
OUTER_SPRINT $sscript(demglasu)   rr#sglab
OUTER_SPRINT $sscript(dempitsu)   rr#spitf

COPY_EXISTING demnabsu.cre "override/demnabsu.cre"
              telcor1.cre  "override/rr#scorn.cre"
              demglasu.cre "override/demglasu.cre"
              rr#hgel.cre  "override/rr#sgelu.cre"
              dempitsu.cre "override/dempitsu.cre"
              telbal1.cre  "override/rr#sbalr.cre"
  
              demosum1.cre "override/rr#smari.cre"                                 //these are only intended for use against the party
              gorsuc01.cre "override/rr#ssucc.cre"
              alufie01.cre "override/rr#saluf.cre"
              cambion1.cre "override/rr#scamb.cre"
              demabi01.cre "override/rr#sabis.cre"
              deriny01.cre "override/rr#serin.cre"
              dbonef01.cre "override/rr#sbfnd.cre"
  WRITE_LONG 0x10 2                                                                // clear flags, leave only "no corpse"
  WRITE_LONG 0x14 0                                                                //XP is handled by script
  PATCH_IF VARIABLE_IS_SET $sscript("%DEST_RES%") BEGIN
    WRITE_ASCIIE 0x248 $sscript("%DEST_RES%") #8                                     // summoned script
  END ELSE BEGIN
    WRITE_ASCIIE 0x248 "%DEST_RES%" #8
  END
  WRITE_ASCII  0x250 ~~ #8                                                         // disable class AI script
  WRITE_ASCII  0x258 ~~ #8                                                         // disable race AI script
  WRITE_ASCII  0x260 ~~ #8                                                         // disable general AI script
  WRITE_ASCII  0x268 ~~ #8                                                         // disable default AI script
  WRITE_BYTE   0x270 128                                                           //Initially neutral
  WRITE_BYTE   0x275 9                                                             //SUMMONED_DEMON 
  WRITE_ASCII  0x280 ~~ #32                                                        //no script name
  READ_LONG 0x2bc io
  FOR (i=0;i<LONG_AT 0x2c0;++i) BEGIN                                              //Make all items unstealable&undroppable
    WRITE_BYTE io + 0x14*i + 0x10 THIS BOR 10
  END
  PATCH_IF FILE_EXISTS_IN_GAME dw#sumfi.itm AND !FILE_CONTAINS_EVALUATED ("%SOURCE_FILE%" "dw#sumfi") BEGIN
    ADD_CRE_ITEM "dw#sumfi" #0 #0 #0 none boots
  END


// Spell changes

COPY_EXISTING ~SPWI707.SPL~  ~override~                                            // Cacofiend
SAY NAME1 #17320 SAY NAME2 #17320  SAY DESC @751 SAY UNIDENTIFIED_DESC @751        // retain old name but set new description
  WRITE_SHORT 0x1e BIT8                                                            //Exclude diviners
  WRITE_SHORT 0x22 14                                                              //Casting animation: conj
  WRITE_SHORT 0x25 2                                                               //School: conj
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN
   WRITE_SHORT ("%abil_off%" + 0x0e + (0x28 * "%index%")) "30"                     // set range to 30 (visual range)
   WRITE_SHORT ("%abil_off%" + 0x12 + (0x28 * "%index%")) "7"                      // set casting time to 7
    READ_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "%abil_fx_idx%"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
     READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
      PATCH_IF (("%opcode%" = "177") AND ("%resref%" STRING_EQUAL_CASE ~SPCACO~)) BEGIN  // effect #177: Use EFF File
        WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "48"               // param1: 48 (MASK_CHAOTIC)
        WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"                // param2: 8 (ALIGN.IDS)
        WRITE_LONG            ("%fx_off%" + 0x0e + ("%abil_fx_idx%" * 0x30)) "90"               // duration: 90 (15 rounds)
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // clone effect
        SET "index2"= "%abil_fx_num%" // kills loop
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "16"             // param1: 16 (MASK_LAWFUL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SCORN" #8    // resref: RR#SCORN (Cornugon)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "100"            // probability1: 100
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "51"             // probability2: 51
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SCORN" #8    // resref: RR#SCORN (Cornugon)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "50"             // probability1: 50
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "0"              // probability2: 0
        SET "delta" = "%delta%" + 3                                                             // mark 3 new effects as added
        WRITE_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) ("%abil_fx_num%" + 3)
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~SPCACO.EFF~ ~override/RR#SCORN.EFF~                                 // create new Summon Cornugon effect file
  WRITE_ASCII 0x30 ~RR#SCORN~ #8                                                   // resref: RR#SCORN (custom summoned Cornagon creature)
BUT_ONLY_IF_IT_CHANGES


COPY_EXISTING ~SPWI807.SPL~  ~override~                                            // Summon Fiend
SAY NAME1 #17360 SAY NAME2 #17360  SAY DESC @752 SAY UNIDENTIFIED_DESC @752        // retain old name but set new description
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN
   WRITE_SHORT ("%abil_off%" + 0x0e + (0x28 * "%index%")) "30"                     // set range to 30 (visual range)
   WRITE_SHORT ("%abil_off%" + 0x12 + (0x28 * "%index%")) "8"                      // set casting time to 8
    READ_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "%abil_fx_idx%"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
     READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
      PATCH_IF (("%opcode%" = "177") AND ("%resref%" STRING_EQUAL_CASE ~SPFIEND~)) BEGIN  // effect #177: Use EFF File
        WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "48"               // param1: 48 (MASK_CHAOTIC)
        WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"                // param2: 8 (ALIGN.IDS)
        WRITE_LONG            ("%fx_off%" + 0x0e + ("%abil_fx_idx%" * 0x30)) "120"              // duration: 120 (20 rounds)
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // clone effect
        SET "index2"= "%abil_fx_num%" // kills loop
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "16"             // param1: 16 (MASK_LAWFUL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SGELU" #8    // resref: RR#SGELU (Gelugon)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "100"            // probability1: 100
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "51"             // probability2: 51
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SGELU" #8    // resref: RR#SGELU (Gelugon)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "50"             // probability1: 50
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "0"              // probability2: 0
        SET "delta" = "%delta%" + 3                                                             // mark 3 new effects as added
        WRITE_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) ("%abil_fx_num%" + 3)
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~SPFIEND.EFF~ ~override/RR#SGELU.EFF~                                // create new Summon Gelugon effect file
  WRITE_ASCII 0x30 ~RR#SGELU~ #8                                                   // resref: RR#SGELU (custom summoned Gelugon creature)
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~SPWI905.SPL~  ~override~                                            // Gate (Wizard)
              ~SPPR703.SPL~  ~override~                                            // Gate (Cleric)
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN
   WRITE_SHORT ("%abil_off%" + 0x0e + (0x28 * "%index%")) "30"                     // set range to 30 (visual range)
  PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~SPWI905~) BEGIN                      // Arcane version
    WRITE_SHORT ("%abil_off%" + 0x12 + (0x28 * "%index%")) "9"                     // set casting time to 9
    SAY NAME1 #14260 SAY NAME2 #14260  SAY DESC @753 SAY UNIDENTIFIED_DESC @753    // retain old name but set new description (arcane)
  END
  PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~SPPR703~) BEGIN                      // Divine version
    WRITE_SHORT ("%abil_off%" + 0x12 + (0x28 * "%index%")) "5"                     // set casting time to 5
    SAY NAME1 #14260 SAY NAME2 #14260  SAY DESC @754 SAY UNIDENTIFIED_DESC @754    // retain old name but set new description (divine)
  END
    READ_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "%abil_fx_idx%"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
     READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
      PATCH_IF (("%opcode%" = "177") AND ("%resref%" STRING_EQUAL_CASE ~SPGATE~)) BEGIN  // effect #177: Use EFF File
        WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "16"               // param1: 16 (MASK_LAWFUL)
        WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"                // param2: 8 (ALIGN.IDS)
        WRITE_LONG            ("%fx_off%" + 0x0e + ("%abil_fx_idx%" * 0x30)) "198"              // duration: 198 (33 rounds)
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // clone effect
        SET "index2"= "%abil_fx_num%" // kills loop
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "48"             // param1: 48 (MASK_CHAOTIC)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SBALR" #8    // resref: RR#SBALR (Balor)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "100"            // probability1: 100
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "51"             // probability2: 51
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SBALR" #8    // resref: RR#SBALR (Balor)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "50"             // probability1: 50
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "0"              // probability2: 0
        SET "delta" = "%delta%" + 3                                                             // mark 3 new effects as added
        WRITE_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) ("%abil_fx_num%" + 3)
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~SPGATE.EFF~ ~override/RR#SBALR.EFF~                                 // create new Summon Balor effect file
  WRITE_ASCII 0x30 ~RR#SBALR~ #8                                                   // resref: RR#SBALR (custom summoned Balor creature)
BUT_ONLY_IF_IT_CHANGES



// Item changes

COPY_EXISTING ~SCRL8I.ITM~  ~override~                                             // Cacofiend scroll
SAY NAME1 #17320 SAY NAME2 #17320  SAY DESC @751 SAY UNIDENTIFIED_DESC @751        // retain old name but set new description
BUT_ONLY_IF_IT_CHANGES
COPY_EXISTING ~SCRL9B.ITM~  ~override~                                             // Summon Fiend scroll
SAY NAME1 #17360 SAY NAME2 #17360  SAY DESC @752 SAY UNIDENTIFIED_DESC @752        // retain old name but set new description
BUT_ONLY_IF_IT_CHANGES
COPY_EXISTING ~SCRL9N.ITM~  ~override~                                             // Gate scroll
SAY NAME1 #14260 SAY NAME2 #14260  SAY DESC @753 SAY UNIDENTIFIED_DESC @753        // retain old name but set new description
BUT_ONLY_IF_IT_CHANGES


// New AI scripts

COMPILE ~aTweaks/BAF/fiends/RR#SNABA.BAF~                                                 // Summoned Nabassu AI script
COMPILE ~aTweaks/BAF/fiends/RR#SCORN.BAF~                                                 // Summoned Cornugon AI script
COMPILE ~aTweaks/BAF/fiends/RR#TEMPT.BAF~                                                 // Summoned Glabrezu script for tempting mortals
COMPILE ~aTweaks/BAF/fiends/RR#SGLAB.BAF~                                                 // Summoned Glabrezu AI script
COMPILE ~aTweaks/BAF/fiends/RR#SGELU.BAF~                                                 // Summoned Gelugon AI script
COMPILE ~aTweaks/BAF/fiends/RR#SPITF.BAF~                                                 // Summoned Pit Fiend AI script
COMPILE ~aTweaks/BAF/fiends/RR#SBALR.BAF~                                                 // Summoned Balor AI script
        ~atweaks/baf/fiends/rr#sabis.baf~                                                 //These are scripts for fiends summoned by other fiends      
        ~atweaks/baf/fiends/rr#saluf.baf~
        ~atweaks/baf/fiends/rr#sbfnd.baf~
        ~atweaks/baf/fiends/rr#scamb.baf~
        ~atweaks/baf/fiends/rr#serin.baf~
        ~atweaks/baf/fiends/rr#smari.baf~
        ~atweaks/baf/fiends/rr#ssucc.baf~
        
COPY_EXISTING ~RUNENEMY.BCS~  ~override~                                           // innocent bystander run away script
  DECOMPILE_BCS_TO_BAF                                                             // replace RunAwayFrom() with RandomWalkContinuous()
    REPLACE_TEXTUALLY ~RunAwayFrom(LastSeenBy(Myself),30)~ ~RandomWalkContinuous()~
  COMPILE_BAF_TO_BCS                                                               // reasoning: RunAwayFrom() often tends to slow down the game
BUT_ONLY_IF_IT_CHANGES
EXTEND_TOP ~RUNENEMY.BCS~ ~aTweaks/BAF/fiends/RUNENEMY.BAF~                               // Make innocent bystanders run away from summoned Fiends


COPY_EXISTING ~MAGE20B.BCS~ ~override~                                             // high level mage script
              ~HELLGEN.BCS~ ~override~                                             // Enslaved Genie (Tears of Bhaal)
DECOMPILE_BCS_TO_BAF                                                               // note: this is basically a bugfix, as ApplySpell() casts the spell at 1st level even if the caster's level is higher than that
  REPLACE_TEXTUALLY EXACT_MATCH ~ApplySpell(Myself,WIZARD_PROTECTION_FROM_EVIL)~ ~ReallyForceSpell(Myself,WIZARD_PROTECTION_FROM_EVIL)~
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES



// ================================================
// Spell Revisions compatibility block starts here
// ================================================

ACTION_IF MOD_IS_INSTALLED SPELL_REV.TP2 0 THEN BEGIN                              // Checks for the main component of Spell Revisions

COPY_EXISTING ~SPCACO.EFF~ ~override~                                              // Summon Cacofiend effect file
  WRITE_ASCII 0x30 ~DEMNABSU~ #8                                                   // resref: SPCACO (Nabassu) i.e. revert from Death Knight

COPY_EXISTING ~SPPR703.SPL~  ~override~                                            // Revert CLERIC_GATE to its original state
  SAY NAME1 #14260 SAY NAME2 #14260  SAY DESC @754 SAY UNIDENTIFIED_DESC @754      // retain old name but set new description (divine)
WRITE_ASCII 0x3a "SPPR703C" #8                                                     // spell icon: SPPR703C
WRITE_ASCII 0x10 "CAS_P03" #8                                                      // casting sound: CAS_P03.WAV
WRITE_SHORT 0x25 "2"                                                               // spell school: 2 (Conjuration)
WRITE_SHORT 0x22 "14"                                                              // casting graphics: 14 (Conjuration)
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN
   WRITE_SHORT ("%abil_off%" + 0x0e + (0x28 * "%index%")) "30"                     // set range to 30 (visual range)
   WRITE_SHORT ("%abil_off%" + 0x12 + (0x28 * "%index%")) "5"                      // set casting time to 5
   WRITE_ASCII ("%abil_off%" + 0x04 + (0x28 * "%index%")) ~SPPR703B~               // revert icon to SPPR703B
    READ_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "%abil_fx_idx%"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
     READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
      PATCH_IF (("%opcode%" = "177") AND ("%resref%" STRING_EQUAL_CASE ~SPCACO~)) BEGIN         // effect #177: Use EFF File
        WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "16"               // param1: 16 (MASK_LAWFUL)
        WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"                // param2: 8 (ALIGN.IDS)
        WRITE_LONG            ("%fx_off%" + 0x0e + ("%abil_fx_idx%" * 0x30)) "198"              // duration: 198 (33 rounds)
        WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "SPGATE" #8        // resref: SPGATE (Pit Fiend)
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // clone effect
        SET "index2"= "%abil_fx_num%" // kills loop
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "48"             // param1: 48 (MASK_CHAOTIC)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SBALR" #8    // resref: RR#SBALR (Balor)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "100"            // probability1: 100
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "51"             // probability2: 51
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#SBALR" #8    // resref: RR#SBALR (Balor)
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30             // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"     // cloned effect
          WRITE_LONG            ("%fx_off%" + 0x04 + ("%abil_fx_idx%" * 0x30)) "32"             // param1: 32 (MASK_LCNEUTRAL)
          WRITE_LONG            ("%fx_off%" + 0x08 + ("%abil_fx_idx%" * 0x30)) "8"              // param2: 8 (ALIGN.IDS)
          WRITE_BYTE            ("%fx_off%" + 0x12 + ("%abil_fx_idx%" * 0x30)) "50"             // probability1: 50
          WRITE_BYTE            ("%fx_off%" + 0x13 + ("%abil_fx_idx%" * 0x30)) "0"              // probability2: 0
        SET "delta" = "%delta%" + 3                                                             // mark 3 new effects as added
        WRITE_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) ("%abil_fx_num%" + 3)
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES


COPY_EXISTING ~DEMNABSU.CRE~ ~override~                                            // Nabassu
              ~DEMGLASU.CRE~ ~override~                                            // Glabrezu
              ~DEMPITSU.CRE~ ~override~                                            // Pit Fiend
  PATCH_IF !FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~RINGDEMN~) BEGIN             // if the creature doesn't possess Fiend immunities
    ADD_CRE_ITEM ~RINGDEMN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~RRING~             // add Fiend immunity ring
  END
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends check for the main component of Spell Revisions


// =============================================
// Spell Revisions compatibility block ends here
// =============================================

